{
  "task": {
    "title": "CLOSING 상태에서 반대 방향 청산 전환 (SWITCH_CLOSING)",
    "description": "CLOSING_TP 상태에서 가격이 역전되어 손절이 필요하거나, CLOSING_SL 상태에서 가격이 회복되어 익절이 가능한 경우, 기존 청산 주문을 취소하고 반대 방향 청산 주문으로 전환하는 기능. 1분봉으로 PnL을 모니터링하고, ENTERING 상태를 경유하며, 전환은 1회로 제한한다.",
    "priority": "high"
  },
  "user_requirements": {
    "pnl_monitoring": "1분봉 (빠른 감지)",
    "state_transition": "ENTERING 경유",
    "cancel_failure": "clear_position()으로 IDLE 복구",
    "switch_limit": "1회 제한"
  },
  "affected_components": [
    {
      "name": "type.py",
      "file": "src/type.py",
      "reason": "SWITCH_CLOSING 액션 타입과 SwitchClosingRequest TypedDict 추가, ApiRequest 유니온 타입 확장"
    },
    {
      "name": "PositionState",
      "file": "src/position_state.py",
      "reason": "_closing_switch_triggered 플래그 추가, try_switch_closing() 메서드 추가, try_trigger_sl_market() 수정, clear_position() 초기화 추가"
    },
    {
      "name": "DataManager",
      "file": "src/data_manager.py",
      "reason": "_check_closing_switch() 메서드 추가, 1분봉 처리 블록에서 호출"
    },
    {
      "name": "ApiManager",
      "file": "src/api_manager.py",
      "reason": "_handle_switch_closing() 핸들러 추가, match 문에 SWITCH_CLOSING case 추가"
    }
  ],
  "architecture_patterns": {
    "primary": "State Machine (PositionState)",
    "secondary": ["Queue-based Async Processing", "Thread-Safe Singleton", "Atomic State Transition"],
    "justification": "기존 상태 머신 패턴(CLOSING_TP/SL -> ENTERING -> CLOSING_SL/TP)을 확장하여 반대 방향 청산 전환을 구현. try_switch_closing()은 기존 try_trigger_sl_market()과 동일한 원자적 전환 패턴을 따르며, ENTERING 경유 → API Queue → 새 CLOSING 상태 흐름은 기존 청산 흐름과 완전히 일치한다."
  },
  "implementation_guide": {
    "steps": [
      {
        "step_number": 1,
        "title": "type.py - SWITCH_CLOSING 액션 추가",
        "description": "ApiRequestAction enum에 SWITCH_CLOSING 값을 추가한다.",
        "file_location": "src/type.py:80"
      },
      {
        "step_number": 2,
        "title": "type.py - SwitchClosingRequest TypedDict 추가",
        "description": "SWITCH_CLOSING 액션에 필요한 요청 타입을 정의한다. 필드: action, cancel_order_id, new_exit_type(ApiRequestAction), direction, qty, price, fallback_price",
        "file_location": "src/type.py:118"
      },
      {
        "step_number": 3,
        "title": "type.py - ApiRequest 유니온 타입 확장",
        "description": "ApiRequest 유니온 타입에 SwitchClosingRequest를 추가한다.",
        "file_location": "src/type.py:134"
      },
      {
        "step_number": 4,
        "title": "position_state.py - _closing_switch_triggered 플래그 추가",
        "description": "__init__에 _closing_switch_triggered 플래그를 추가한다.",
        "file_location": "src/position_state.py:48"
      },
      {
        "step_number": 5,
        "title": "position_state.py - try_switch_closing() 메서드 추가",
        "description": "CLOSING_TP/CLOSING_SL -> ENTERING 원자적 전환. _sl_market_triggered도 True 설정.",
        "file_location": "src/position_state.py:253"
      },
      {
        "step_number": 6,
        "title": "position_state.py - try_trigger_sl_market() 수정",
        "description": "_closing_switch_triggered 체크 추가하여 양방향 상호 배타성 보장.",
        "file_location": "src/position_state.py:237"
      },
      {
        "step_number": 7,
        "title": "position_state.py - clear_position() 초기화 추가",
        "description": "_closing_switch_triggered = False 초기화 추가.",
        "file_location": "src/position_state.py:163"
      },
      {
        "step_number": 8,
        "title": "data_manager.py - import 추가",
        "description": "SwitchClosingRequest를 import 목록에 추가.",
        "file_location": "src/data_manager.py:9"
      },
      {
        "step_number": 9,
        "title": "data_manager.py - _check_closing_switch() 메서드 추가",
        "description": "CLOSING 상태에서 반대 방향 시그널 확인. check_exit_signal + calculate_exit_limit_price + try_switch_closing + API Queue",
        "file_location": "src/data_manager.py:290"
      },
      {
        "step_number": 10,
        "title": "data_manager.py - 1분봉 처리에서 호출 추가",
        "description": "_check_sl_limit_failure() 직후에 _check_closing_switch() 호출.",
        "file_location": "src/data_manager.py:101"
      },
      {
        "step_number": 11,
        "title": "api_manager.py - import 추가",
        "description": "SwitchClosingRequest를 import 목록에 추가.",
        "file_location": "src/api_manager.py:7"
      },
      {
        "step_number": 12,
        "title": "api_manager.py - _handle_switch_closing() 핸들러 추가",
        "description": "기존 주문 취소 -> 새 지정가 주문 생성 -> set_closing_tp/sl. 취소 실패 시 clear_position() + return.",
        "file_location": "src/api_manager.py:300"
      },
      {
        "step_number": 13,
        "title": "api_manager.py - match 문에 SWITCH_CLOSING case 추가",
        "description": "EXIT_SL_MARKET case 아래에 SWITCH_CLOSING case 추가.",
        "file_location": "src/api_manager.py:70"
      }
    ]
  },
  "risks_and_considerations": [
    {
      "risk": "API Queue 처리 지연으로 SWITCH_CLOSING 요청 전에 기존 주문이 체결될 수 있음",
      "severity": "medium",
      "mitigation": "_handle_switch_closing()에서 cancel_order 실패 시 clear_position() + return으로 안전하게 복구."
    },
    {
      "risk": "CLOSING_TP -> SL 전환 후 가격이 다시 유리해져도 재전환 불가 (1회 제한)",
      "severity": "low",
      "mitigation": "의도적 설계. 무한 전환 루프를 방지."
    },
    {
      "risk": "_check_sl_limit_failure()와 _check_closing_switch() 동시 트리거",
      "severity": "low",
      "mitigation": "호출 순서 + 양방향 플래그 잠금으로 안전."
    },
    {
      "risk": "전환 후 새 CLOSING_SL 상태에서 시장가 손절 전환 불가",
      "severity": "medium",
      "mitigation": "try_switch_closing()에서 _sl_market_triggered=True 설정으로 의도적 차단. OrderMonitor 체결 확인이나 바이낸스 주문 만료로 처리."
    }
  ],
  "test_strategy": {
    "unit_tests": [
      "try_switch_closing(): CLOSING_TP -> ENTERING 전환 성공",
      "try_switch_closing(): CLOSING_SL -> ENTERING 전환 성공",
      "try_switch_closing(): 2회 호출 시 2번째 실패 (1회 제한)",
      "try_switch_closing(): IDLE/ACTIVE 상태에서 실패",
      "try_switch_closing(): _sl_market_triggered=True 확인",
      "try_trigger_sl_market(): _closing_switch_triggered=True 시 실패",
      "clear_position(): _closing_switch_triggered=False 확인"
    ],
    "integration_tests": [
      "CLOSING_TP + EXIT_SL 시그널 -> SWITCH_CLOSING 요청",
      "CLOSING_SL + EXIT_TP 시그널 -> SWITCH_CLOSING 요청",
      "CLOSING_TP + EXIT_TP 시그널 (동일 방향) -> 전환 안함",
      "취소 성공 -> 새 주문 생성 -> set_closing_tp/sl 호출",
      "취소 실패 -> clear_position() 호출"
    ],
    "edge_cases": [
      "_check_sl_limit_failure와 _check_closing_switch 동시 조건 충족",
      "API Queue Full 시 clear_position() 복구",
      "entry_price=None 시 조기 return",
      "새 주문 실패 시 clear_position() + Discord 알림"
    ]
  },
  "documentation_updates": [
    {
      "file": "CLAUDE.md",
      "section": "포지션 상태 머신",
      "changes": "CLOSING_TP/SL -> ENTERING -> CLOSING_SL/TP 전환 흐름도 추가"
    },
    {
      "file": "CLAUDE.md",
      "section": "데이터 흐름",
      "changes": "청산 방향 전환 시나리오 추가"
    },
    {
      "file": "CLAUDE.md",
      "section": "주요 컴포넌트 > PositionState",
      "changes": "_closing_switch_triggered, try_switch_closing() 설명 추가"
    },
    {
      "file": "CLAUDE.md",
      "section": "주요 컴포넌트 > ApiManager > 처리 액션",
      "changes": "SWITCH_CLOSING 액션 설명 추가"
    }
  ],
  "related_references": {
    "existing_implementations": [
      "src/position_state.py:237 - try_trigger_sl_market() (동일 패턴)",
      "src/data_manager.py:238 - _check_sl_limit_failure() (동일 패턴)",
      "src/api_manager.py:220 - _handle_exit_sl_market() (취소+새주문 패턴)",
      "src/data_manager.py:220-226 - CLOSING placeholder (기존 pass 블록)",
      "src/strategy_manager.py:127 - check_exit_signal() (PnL 계산 재사용)",
      "src/strategy_manager.py:309 - calculate_exit_limit_price() (지정가 계산 재사용)"
    ]
  }
}